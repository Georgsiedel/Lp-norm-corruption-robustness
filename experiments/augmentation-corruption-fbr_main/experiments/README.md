# Experiments

This code reproduces the experiments in the paper.  It uses [submitit](https://github.com/facebookincubator/submitit) to launch the job, by default to your local machine, and uses [hydra](https://github.com/facebookresearch/hydra) to manage configuration.  

PyTorch with CUDA support is required in addition to the dependencies in `requirements.txt`. Various paths must be set in `conf/paths.yaml`. This includes the path to the CIFAR-10 and ImageNet datasets. Additionally, to test on the ImageNet-C _frost_ corruption it is necessary to obtain the frost images from the [ImageNet-C code repository](https://github.com/hendrycks/robustness) and indicate the path to these images. 

The rest of this README describes the basic usage of the tools used to run the experiments. These commands as configured for the experiments in the paper can be found in `scripts/`.

The experiment of section 4 can be run using `feature_corrupt_error.py`.  For instance, 

```
python feature_corrupt_error.py train.params.aug_string=posterize-3--equalize-3--translate_x-3
```

will generate a single datapoint on the plots in Section 4, specifically for augmentations that include posterize, equalize, and x-translation. Instead of training a feature extractor from scratch, pre-trained weights may used by including the override `ft.params.dataset_cfg.weights=<PATH_TO_CHECKPOINT>`.

Given trained models and a set of training image indices for the feature extractor, the following will calculate errors and features for the specified corruptions. For instance, for _single frequency greyscale_ at severity 1 in magnitude range 0 to 3:

```
python severity_scan.py optim.max_epoch=0 ft.params.optim_cfg.max_epoch=0 train.weights=<TRAINED_MODEL_PATH>  ft.params.dataset_cfg.weights=<TRAINED_FEATURE_EXTRACTOR> ft_corrupt.indices_file=<INDICES> aug_string=single_frequency_greyscale-0_3 severity=1
```

In experiments the severity parameter above is an integer between 1 and 10, while `corruption_master_list.csv` gives the ranges of magnitudes of each corruption on CIFAR-10 and ImageNet. Magnitude ranges have been chosen so that corrupted images are human intepretable and that the range of corruption errors roughly matches CIFAR10/ImageNet-C.

Given base directories for CIFAR-10/ImageNet-C and new corruption errors and features generated by `severity_scan`, `sample_datasets.py` will collect these into groups of 5 new corruptions with the specified average error and will calculate the distance to ImageNet-C:

```
python sample_datasets.py --new_corr_dir=<NEW_CORR_DIR> --baseline_corr_dir=<IMAGENET_C_DIRR> --target=<TARGET_ERROR>
```

The target error may be extracted from the ImageNet-C severity scan using `tools/get_target_error.py`. Finally, `calc_distance_shifts.py` will take multiple runs generated by `sample_datasets.py` and calculate both the shifts associated with each corruption, as well as choose a dataset from among the 10 farthest corruptions:

```
python calc_distance_shifts.py --input_files=<COMMA_SEPARATED_SAMPLED_DATASETS> --target=<TARGET_ERROR>
```

A model may be tested on a given set of corruptions and severities using

```
python test_cifar10.py weights=<PATH_TO_CHECKPOINT> corrupt.aug_string=single_frequency_greyscale-1.0--sparkles-2.0
```

If no set of corruptions is provided, it will default to CIFAR-10/ImageNet-C.
